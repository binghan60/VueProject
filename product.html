<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="css/reset.css" />
		<link rel="stylesheet" href="css/products.css" />
		<meta name="description" content="Vue產品頁" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.5/axios.min.js" integrity="sha512-TjBzDQIDnc6pWyeM1bhMnDxtWH0QpOXMcVooglXrali/Tj7W569/wd4E8EDjk1CwOAOPSJon1VfcEt1BI4xIrA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<title>產品列表</title>
	</head>
	<body>
		<div id="app">
			<div class="container">
				<div class="productList">
					<div class="header">
						<h2>產品列表</h2>
						<button type="button" @click="toggleModal();">新增產品</button>
					</div>
					<div class="tbl-header">
						<table cellpadding="0" cellspacing="0" border="0">
							<thead>
								<tr>
									<th>產品名稱</th>
									<th>原價</th>
									<th>售價</th>
									<th>是否啟用</th>
									<th>查看細節</th>
								</tr>
							</thead>
						</table>
					</div>
					<div class="tbl-content">
						<table cellpadding="0" cellspacing="0" border="0">
							<tbody>
								<tr v-for="product in products">
									<td>{{ product.title }}</td>
									<td style="text-align: center">{{ product.origin_price }}</td>
									<td style="text-align: center">{{ product.price }}</td>
									<td style="text-align: center"><span v-if="product.is_enabled == 1" style="color: rgb(13, 228, 13); font-weight: 900">是</span><span v-else style="color: rgb(235, 0, 0); font-weight: 900">否</span></td>
									<td style="text-align: center"><button type="button" class="edit" @click="openModal(product.id)">編輯</button><button type="button" class="delete" @click="deleteProduct(product.id)">刪除</button></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<div class="modal" :style="{display:showModal?'flex':''}">
					<div class="card">
						<div class="card-header">
							<img :src="currentProduct.imageUrl" alt="mainImg" />
						</div>
						<div class="card-body">
							<p>產品名稱</p>
							<input type="text" v-model="currentProduct.title" />
							<p>原價</p>
							<input type="number" v-model.number="currentProduct.origin_price" />
							<p>售價</p>
							<input type="number" v-model.number="currentProduct.price" />
							<p>是否啟用</p>
							<div style="display: flex">
								<div><input id="active-T" type="radio" v-model="currentProduct.is_enabled" value="1" /><label for="active-T">啟用</label></div>
								<div><input id="active-F" type="radio" v-model="currentProduct.is_enabled" value="0" /><label for="active-F">禁用</label></div>
							</div>
						</div>
						<div class="btnContainer">
							<div>
								<button type="button" class="cancel" @click="toggleModal()">取消</button>
							</div>
							<div>
								<button type="button" class="confirm" @click="editProduct(currentProduct.id)">送出</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="loading">
			<div class="loadingContainer">
				<div class="loader"></div>
			</div>
		</div>
		<script type="module">
			const url = "https://ec-course-api.hexschool.io/v2";
			const path = "binghank";
			import { createApp } from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.3/vue.esm-browser.min.js";
			createApp({
				data() {
					return {
						products: [],
						currentProduct: "",
						showModal: false
					};
				},
				methods: {
					getAllProduct() {
						axios
							.post(`${url}/api/user/check`, null)
							.then((res) => {
								return axios(`${url}/api/${path}/admin/products/all`);
							})
							.then((response) => {
								const { products } = response.data;
								this.products = products;
								document.querySelector("#loading").style.display = "none";
							})
							.catch((err) => {
								console.log(err);
								const { success } = err.response.data;
								if (!success) {
									alert("請先登入");
									document.querySelector("#loading").style.display = "none";
									location.href = "index.html";
								}
							});
					},
					openModal(id) {
						this.currentProduct = { ...this.products[id] };
						document.querySelector(".modal").style.display = "flex";
						this.toggleModal();
					},
					editProduct() {
						document.querySelector("#loading").style.display = "block";
						const { currentProduct } = this;
						axios.put(`${url}/api/${path}/admin/product/${currentProduct.id}`, { data: currentProduct }).then((res) => {
							console.log(res.data);
							this.getAllProduct();
							this.toggleModal();
						});
					},
					deleteProduct(id) {
						if (confirm(`確認刪除${this.products[id].title}`)) {
							document.querySelector("#loading").style.display = "block";
							axios.delete(`${url}/api/${path}/admin/product/${id}`).then((res) => {
								console.log(res.data);
								this.getAllProduct();
							});
						}
					},
					toggleModal() {
						this.showModal = !this.showModal;
					}
				},
				mounted() {
					const token = document.cookie.replace(/(?:(?:^|.*;\s*)hexVueToken\s*\=\s*([^;]*).*$)|^.*$/, "$1");
					axios.defaults.headers.common.Authorization = token;
					if (!token) {
						alert("請先登入");
						location.href = "index.html";
					}
					this.getAllProduct();
				}
			}).mount("#app");
		</script>
	</body>
</html>
